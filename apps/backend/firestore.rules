rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }
    
    function isSPV() {
      return request.auth.token.role == 'spv';
    }
    
    function isKYCApproved() {
      return request.auth.token.kycStatus == 'approved';
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow write: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated();
    }
    
    // Projects collection
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (isSPV() || isAdmin()) && isKYCApproved();
      allow update: if isAuthenticated() && (resource.data.spvId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Investments collection
    match /investments/{investmentId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && isKYCApproved();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Profit distributions collection
    match /profit_distributions/{distributionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Profit claims collection
    match /profit_claims/{claimId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Transactions collection
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAdmin();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Governance proposals collection
    match /governance_proposals/{proposalId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isKYCApproved();
      allow update: if isAuthenticated() && (resource.data.proposerId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // System configuration collection (Admin only)
    match /system_configuration/{configId} {
      allow read, write: if isAdmin();
    }
    
    // Audit logs collection (Admin only)
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only server can write to audit logs
    }
  }
}